name: LLM Bot Runner

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'LLM的任务描述'
        required: true
        type: string
      context:
        description: '任务的JSON上下文'
        required: true
        type: string

jobs:
  run-llm-bot:
    runs-on: ubuntu-latest
    env:
      LLM_TASK: ${{ inputs.task }}
      LLM_CONTEXT: ${{ inputs.context }}
      # GitHub身份令牌（4个名称都设置）
      GITHUB_TOKEN: ${{ secrets.WEINAR_API_KEY }}
      GH_TOKEN: ${{ secrets.WEINAR_API_KEY }}
      GITHUBTOKEN: ${{ secrets.WEINAR_API_KEY }}
      GHTOKEN: ${{ secrets.WEINAR_API_KEY }}
      # Claude Code环境变量配置
      ANTHROPIC_API_KEY: ${{ secrets.MIMO_API_KEY }}
      ANTHROPIC_AUTH_TOKEN: ${{ secrets.MIMO_API_KEY }}
      ANTHROPIC_BASE_URL: "https://api.xiaomimimo.com/anthropic"
      ANTHROPIC_DEFAULT_OPUS_MODEL: "mimo-v2-flash"
      ANTHROPIC_DEFAULT_SONNET_MODEL: "mimo-v2-flash"
      ANTHROPIC_DEFAULT_HAIKU_MODEL: "mimo-v2-flash"
      # MCP服务器环境变量
      CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
      # 系统提示词
      SYSTEM_PROMPT: ${{ vars.SYSTEM_PROMPT }}
      # 其他令牌
      MIMO_API_KEY: ${{ secrets.MIMO_API_KEY }}
      WEINAR_API_KEY: ${{ secrets.WEINAR_API_KEY }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
      discussions: write
    steps:

      - name: 安装Claude CLI
        run: |
          curl -fsSL https://claude.ai/install.sh | bash

      - name: 安装uv包管理器
        uses: astral-sh/setup-uv@v7

      - name: 验证令牌和环境变量
        run: |
          echo "验证环境变量..."
          # 验证GitHub令牌
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "错误: GITHUB_TOKEN未设置"
            exit 1
          else
            echo "GitHub令牌已设置"
          fi
          # 验证Anthropic认证令牌
          if [ -z "$ANTHROPIC_AUTH_TOKEN" ]; then
            echo "错误: ANTHROPIC_AUTH_TOKEN未设置"
            exit 1
          else
            echo "Anthropic认证令牌已设置"
          fi
          # 验证系统提示词
          if [ -z "$SYSTEM_PROMPT" ]; then
            echo "错误: SYSTEM_PROMPT未设置"
            exit 1
          else
            echo "系统提示词已设置"
          fi

      - name: 添加MCP服务器
        run: |
          # 添加DuckDuckGo搜索服务器
          echo "添加DuckDuckGo搜索服务器..."
          claude mcp add ddg-search -- uvx duckduckgo-mcp-server

          # 添加Context7 HTTP服务器（如果CONTEXT7_API_KEY已设置）
          if [ -n "$CONTEXT7_API_KEY" ]; then
            echo "添加Context7 HTTP服务器..."
            claude mcp add --transport http context7 https://mcp.context7.com/mcp \
              --header "CONTEXT7_API_KEY: $CONTEXT7_API_KEY"
          else
            echo "警告: CONTEXT7_API_KEY未设置，跳过Context7服务器添加"
          fi
        env:
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}

      - name: 以GitHub机器人身份运行Claude Code
        run: |
          echo "运行Claude Code..."
          echo "原始任务: $LLM_TASK"
          echo "系统提示词长度: ${#SYSTEM_PROMPT} 字符"

          # 将JSON上下文写入文件
          echo "$LLM_CONTEXT" > context.json
          CONTEXT_CHARS=$(wc -m < context.json)
          echo "上下文文件大小: $CONTEXT_CHARS 字符"
          echo "上下文内容:"
          cat context.json
          echo ""

          # 构建新任务字符串，包含读取context.json的指示
          ENHANCED_TASK=$(printf "%s\n\n> 任务上下文已保存，共%s字符。阅读context.json文件以了解上下文！" "$LLM_TASK" "$CONTEXT_CHARS")
          echo "增强任务: $ENHANCED_TASK"

          claude \
            -p "$ENHANCED_TASK" \
            --system-prompt "$SYSTEM_PROMPT" \
            --allowedTools "Bash,TaskOutput,Edit,ExitPlanMode,Glob,Grep,KillShell,MCPSearch,NotebookEdit,Read,Skill,Task,TaskCreate,TaskGet,TaskList,TaskUpdate,WebFetch,WebSearch,Write,mcp__ddg-search__*,mcp__context7__*" \
            --output-format=stream-json \
            --verbose
