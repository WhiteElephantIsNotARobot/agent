name: Update System Prompt

on:
  push:
    paths:
      - 'system_prompt.md'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    env:
      GH_TOKEN: ${{ secrets.REPOSITORY_VARIABLE_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get old SYSTEM_PROMPT value
        id: get_old_value
        run: |
          echo "正在获取旧的 SYSTEM_PROMPT 值..."

          # 获取旧值并保存到临时文件
          OLD_VALUE=$(gh api /repos/${{ github.repository }}/actions/variables/SYSTEM_PROMPT --jq '.value' 2>/dev/null || echo "")

          if [ -z "$OLD_VALUE" ]; then
            echo "未找到现有的 SYSTEM_PROMPT 变量，将作为新变量创建"
          else
            echo "已获取旧值，长度: ${#OLD_VALUE} 字符"
          fi

          # 保存到临时文件（使用 base64 编码以避免特殊字符问题）
          echo "$OLD_VALUE" | base64 -w 0 > /tmp/old_value.txt
          echo "old_value_saved=true" >> $GITHUB_OUTPUT

      - name: Update SYSTEM_PROMPT variable
        run: |
          echo "正在更新 SYSTEM_PROMPT 变量..."

          # 检查 system_prompt.md 文件是否存在
          if [ ! -f "system_prompt.md" ]; then
            echo "错误: system_prompt.md 文件不存在"
            exit 1
          fi

          # 读取 system_prompt.md 内容
          SYSTEM_PROMPT_CONTENT=$(cat system_prompt.md)

          # 更新 GitHub Actions 变量
          gh api --method PATCH \
            /repos/${{ github.repository }}/actions/variables/SYSTEM_PROMPT \
            -f name=SYSTEM_PROMPT \
            -f value="$SYSTEM_PROMPT_CONTENT"

          echo "✓ SYSTEM_PROMPT 变量已更新"
          echo "文件大小: $(wc -c < system_prompt.md) 字符"

      - name: Create diff issue
        if: steps.get_old_value.outputs.old_value_saved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // 读取旧值
            const fs = require('fs');
            const oldValueBase64 = fs.readFileSync('/tmp/old_value.txt', 'utf8');
            const oldValue = Buffer.from(oldValueBase64, 'base64').toString('utf-8');

            // 读取新值
            const newContent = fs.readFileSync('system_prompt.md', 'utf-8');

            // 生成 diff
            const diff = generateDiff(oldValue, newContent);

            // 构建 issue 内容
            const runUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const issueBody = `[工作流运行 #${process.env.GITHUB_RUN_ID}](${runUrl})\n\n${diff}`;

            // 创建 issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[工作流] 提示词更新 ${process.env.GITHUB_RUN_ID}`,
              body: issueBody,
              labels: ['workflow', 'documentation']
            });

            console.log(`✓ Issue created: #${issue.data.number}`);

            function generateDiff(oldStr, newStr) {
              const oldLines = oldStr.split('\n');
              const newLines = newStr.split('\n');

              let diff = '```diff\n';
              diff += `--- 旧变量 (${oldLines.length} 行)\n`;
              diff += `+++ 新变量 (${newLines.length} 行)\n`;

              const maxLines = Math.max(oldLines.length, newLines.length);
              for (let i = 0; i < maxLines; i++) {
                const oldLine = oldLines[i];
                const newLine = newLines[i];

                if (oldLine === newLine) {
                  diff += `  ${newLine}\n`;
                } else if (oldLine && !newLine) {
                  diff += `- ${oldLine}\n`;
                } else if (!oldLine && newLine) {
                  diff += `+ ${newLine}\n`;
                } else {
                  diff += `- ${oldLine}\n`;
                  diff += `+ ${newLine}\n`;
                }
              }

              diff += '```';
              return diff;
            }